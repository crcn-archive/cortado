// Generated by CoffeeScript 1.6.3
var Tester, async;

async = require("async");

Tester = require("./tester");

exports.require = ["browser.launchers.*", "sock.clients", "tests", "config", "pubsub"];

exports.plugin = function(launcher, clients, tests, config, pubsub) {
  var browsers, limit, ops, running, tester, _ref;
  browsers = config.get("browsers") || [];
  limit = config.get("limit") || 1;
  ops = {
    host: (_ref = config.get("host")) != null ? _ref : "localhost",
    port: config.get("port")
  };
  if (!browsers.length) {
    return;
  }
  running = false;
  tester = {
    run: function() {
      if (running) {
        return;
      }
      running = true;
      return async.eachLimit(browsers, limit, (function(browser, next) {
        return tester = new Tester(launcher, browser, clients, pubsub, ops).run(next);
      }), function(err) {
        var hasError;
        running = false;
        hasError = false;
        if (err != null) {
          return hasError = true;
        } else {
          return console.log("completed tests without errors");
        }
      });
    }
  };
  return pubsub.subscribe("init", tester.run);
};
