// Generated by CoffeeScript 1.6.3
var Url, browserify, cacher, createClients, crypto, events, express, fs, gaze, glob, http, httpProxy, saveBundledScripts, sockjs, startServer, watchScripts;

express = require("express");

httpProxy = require("http-proxy");

Url = require("url");

browserify = require("browserify-middleware");

glob = require("glob");

fs = require("fs");

crypto = require("crypto");

events = require("events");

gaze = require("gaze");

sockjs = require("sockjs");

http = require("http");

/*
*/


cacher = function(options) {
  var cache, dir, types;
  if (!options.full) {
    return function(req, res, next) {
      return next();
    };
  }
  cache = options.cache;
  types = cache.types;
  dir = cache.directory;
  return function(req, res, next) {};
};

/*
*/


saveBundledScripts = function(clients, options) {
  var buffer, hash, script, scripts, tmpScript, _i, _j, _len, _len1, _ref;
  scripts = [];
  _ref = options.scripts;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    script = _ref[_i];
    scripts = glob.sync(script).concat(scripts);
  }
  buffer = [];
  for (_j = 0, _len1 = scripts.length; _j < _len1; _j++) {
    script = scripts[_j];
    buffer.push("require('" + script + "');");
  }
  hash = crypto.createHash('md5').update(options.cwd).digest("hex");
  tmpScript = "/tmp/" + hash + ".js";
  fs.writeFileSync(tmpScript, buffer.join("\n;"));
  clients.send({
    event: "reload"
  });
  return tmpScript;
};

/*
*/


watchScripts = function(options, callback) {
  return gaze(options.scripts, function() {
    return this.on("all", callback);
  });
};

/*
*/


createClients = function(sock) {
  var _clients;
  _clients = [];
  sock.on("connection", function(con) {
    return _clients.push(con);
  });
  return {
    send: function(data) {
      var client, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = _clients.length; _i < _len; _i++) {
        client = _clients[_i];
        _results.push(client.write(JSON.stringify(data)));
      }
      return _results;
    }
  };
};

/*
*/


startServer = function(options) {
  var app, clients, port, proxy, server, sock, urlInfo;
  options.cwd = process.cwd();
  proxy = new httpProxy.RoutingProxy();
  app = express();
  server = http.createServer(app);
  port = options.port || 8083;
  console.log("listening on port %d", port);
  urlInfo = Url.parse(options.proxy);
  app.use(cacher(options));
  app.use("/test", express["static"](__dirname + "/public"));
  app.use("/test/js/app.bundle.js", browserify(__dirname + "/public/js/index.js"));
  sock = sockjs.createServer({
    sockjs_url: "http://cdn.sockjs.org/sockjs-0.3.min.js"
  });
  clients = createClients(sock);
  sock.installHandlers(server, {
    prefix: "/sock"
  });
  app.use("/test/js/scripts.bundle.js", browserify(saveBundledScripts(clients, options)));
  watchScripts(options, function() {
    return saveBundledScripts(clients, options);
  });
  app.all("/**", function(req, res) {
    return proxy.proxyRequest(req, res, {
      host: urlInfo.hostname,
      port: urlInfo.port
    });
  });
  return server.listen(port);
};

exports.start = function(config) {
  return startServer(config);
};
