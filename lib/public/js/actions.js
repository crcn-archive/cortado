// Generated by CoffeeScript 1.6.3
var Log, fasten, fastener, hurryup;

fasten = require("fasten");

fastener = fasten();

hurryup = require("hurryup");

Log = require("./models/log");

fastener.add("actions", {
  visit: {
    call: function(url, next) {
      var _this = this;
      this.models.set("control.location", url);
      return this.models.bind("control.document", function() {
        return next(null, _this);
      }).once().now();
    }
  },
  type: {
    call: function(path, value, next) {
      var _this = this;
      return this.findElements(path, function(err, $elements) {
        if (err != null) {
          return next(err);
        }
        $elements.val(value);
        $elements.trigger("keydown");
        $elements.trigger("keyup");
        $elements.trigger("change");
        $elements.trigger("click");
        return next(null, _this);
      });
    }
  },
  click: {
    call: function(path, next) {
      return this.findElements(path, function(err, $elements) {
        if (err != null) {
          return next(err);
        }
        $elements.trigger("click");
        return next(null, this);
      });
    }
  },
  find: function(path, fn, next) {
    return this.findElements(path, function(err, $elements) {
      var e;
      if (err != null) {
        return next(err);
      }
      try {
        fn($elements);
      } catch (_error) {
        e = _error;
        next(e, this);
      }
      return next(null, this);
    });
  },
  then: function(fn, next) {
    var e;
    try {
      fn();
    } catch (_error) {
      e = _error;
      return next(e);
    }
    return next();
  }
});

module.exports = function(models) {
  var target;
  target = {
    models: models,
    findElements: function(path, next) {
      var fn;
      fn = hurryup((function(path, next) {
        var $els, cdoc, e;
        if (!(cdoc = models.get("control.document"))) {
          return next(new Error("control document is not defined"));
        }
        try {
          $els = $(cdoc).xpath(path);
        } catch (_error) {
          e = _error;
          return next(new Error("xpath " + path + " is invalid"));
        }
        if (!$els.length) {
          return next(new Error("no elements found for path " + path));
        }
        return setTimeout(next, 5, null, $els);
      }), {
        timeout: 1000 * 3,
        retry: true,
        retryTimeout: 100
      });
      fn.call(this, path, next);
      return this;
    }
  };
  fastener = fastener.wrap("actions", target);
  fastener.on("error", function() {
    return models.addLog({
      description: "fail",
      success: false
    });
  });
  fastener.on("result", function(data) {
    return models.addLog({
      description: "" + data.method + "(" + (data.args.join(', ')) + ")",
      success: true,
      type: "action"
    });
  });
  return fastener;
};
